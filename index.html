<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Trends (Mixed APIs)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; background: #f7f7f8; color: #111; }
    .center { text-align: center; }
    .card { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 6px 18px rgba(16,24,40,0.06); max-width: 1000px; margin: 20px auto; }
    input[type="password"] { padding: 8px 10px; font-size: 16px; border-radius: 6px; border: 1px solid #d0d7de; }
    button { padding: 8px 12px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; background:#2563eb; color:white; }
    button:disabled { opacity: 0.6; cursor: default; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e6e6e9; font-family: monospace; }
    th { background: #fafafa; font-weight: 600; }
    .muted { color: #666; font-size: 14px; }
    .loading { display:inline-block; margin-left:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
</head>
<body>
<div id="app" class="card">
  <div id="loginView" class="center">
    <h2>üîí Enter Password</h2>
    <div>
      <input id="passwordInput" type="password" placeholder="Password" />
      <button id="unlockBtn">Unlock</button>
    </div>
    <p id="loginMsg" class="muted">This page will fetch market data for symbols and compute SMAs.</p>
  </div>

  <div id="mainView" style="display:none;">
    <h2>üìä Market Trends</h2>
    <div id="controls" class="muted">
      <span id="statusText">Idle</span>
      <button id="refreshBtn" style="margin-left:12px;">Refresh</button>
    </div>

    <div id="tableContainer" style="margin-top:12px;">
      <div id="loadingBlock" style="display:none;" class="muted">Loading data<span class="loading">‚è≥</span></div>
      <table id="resultsTable" style="display:none;">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Trend</th>
            <th>SMA50</th>
            <th>SMA100</th>
            <th>SMA200</th>
            <th>SMA500</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  const API_KEY = "b03b52a7e2e348b994a45de0b3f6ae09";
  const encryptionKey = "secretKey";
  const encryptedPassword = CryptoJS.AES.encrypt("9617", encryptionKey).toString();

  const loginView = document.getElementById('loginView');
  const mainView = document.getElementById('mainView');
  const passwordInput = document.getElementById('passwordInput');
  const unlockBtn = document.getElementById('unlockBtn');

  const statusText = document.getElementById('statusText');
  const refreshBtn = document.getElementById('refreshBtn');
  const loadingBlock = document.getElementById('loadingBlock');
  const resultsTable = document.getElementById('resultsTable');
  const resultsBody = document.getElementById('resultsBody');

  let authorized = false;

  // Symbol lists
  const yahooSymbols = ["^DJI", "^NDX"]; // US30 and US100
  const twelveSymbols = ["XAU/USD", "EUR/USD", "GBP/USD", "USD/JPY", "USD/CHF", "USD/CAD"];

  function calculateSMA(prices, period) {
    const res = new Array(prices.length).fill(null);
    for (let i = 0; i < prices.length; i++) {
      if (i < period - 1) continue;
      let sum = 0;
      for (let j = i - period + 1; j <= i; j++) sum += prices[j];
      res[i] = sum / period;
    }
    return res;
  }

  async function getYahooTrend(symbol) {
    try {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=2y`;
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const resp = await axios.get(proxyUrl);

      const data = resp.data.chart.result?.[0];
      if (!data) return { symbol, trend: "Error fetching data" };

      const closes = data.indicators.quote[0].close;
      const SMA50 = calculateSMA(closes, 50);
      const SMA100 = calculateSMA(closes, 100);
      const SMA200 = calculateSMA(closes, 200);
      const SMA500 = calculateSMA(closes, 500);

      const lastClose = closes[closes.length - 1];
      const lastSMA50 = SMA50[SMA50.length - 1];
      const lastSMA100 = SMA100[SMA100.length - 1];
      const lastSMA200 = SMA200[SMA200.length - 1];
      const lastSMA500 = SMA500[SMA500.length - 1];

      let trend;
      if (lastSMA50 && lastSMA100 && lastSMA200 && lastSMA500) {
        if (lastSMA50 > lastSMA100 && lastSMA100 > lastSMA200 && lastSMA200 > lastSMA500 && lastClose > lastSMA50)
          trend = `Uptrend üìà (${lastClose.toFixed(2)})`;
        else if (lastSMA50 < lastSMA100 && lastSMA100 < lastSMA200 && lastSMA200 < lastSMA500 && lastClose < lastSMA50)
          trend = `Downtrend üìâ (${lastClose.toFixed(2)})`;
        else
          trend = `Sideways ‚û°Ô∏è (${lastClose.toFixed(2)})`;
      } else {
        trend = `Insufficient data (${lastClose ? lastClose.toFixed(2) : "-"})`;
      }

      return { symbol, trend, SMA50: lastSMA50, SMA100: lastSMA100, SMA200: lastSMA200, SMA500: lastSMA500 };
    } catch (err) {
      console.error("Yahoo error", symbol, err);
      return { symbol, trend: "Error fetching data" };
    }
  }

  async function getTwelveTrend(symbol) {
    try {
      const url = "https://api.twelvedata.com/time_series";
      const resp = await axios.get(url, {
        params: {
          symbol,
          interval: "5min",
          outputsize: 500,
          apikey: API_KEY,
        },
      });

      const data = resp.data;
      if (!data.values) return { symbol, trend: "Error fetching data" };

      const values = data.values
        .map(v => ({ datetime: new Date(v.datetime), close: parseFloat(v.close) }))
        .sort((a, b) => a.datetime - b.datetime);

      const closes = values.map(v => v.close);
      const SMA50 = calculateSMA(closes, 50);
      const SMA100 = calculateSMA(closes, 100);
      const SMA200 = calculateSMA(closes, 200);
      const SMA500 = calculateSMA(closes, 500);

      const lastClose = closes[closes.length - 1];
      const lastSMA50 = SMA50[SMA50.length - 1];
      const lastSMA100 = SMA100[SMA100.length - 1];
      const lastSMA200 = SMA200[SMA200.length - 1];
      const lastSMA500 = SMA500[SMA500.length - 1];

      let trend;
      if (lastSMA50 != null && lastSMA100 != null && lastSMA200 != null && lastSMA500 != null) {
        if (lastSMA50 > lastSMA100 && lastSMA100 > lastSMA200 && lastSMA200 > lastSMA500 && lastClose > lastSMA50)
          trend = `Uptrend üìà (${lastClose.toFixed(2)})`;
        else if (lastSMA50 < lastSMA100 && lastSMA100 < lastSMA200 && lastSMA200 < lastSMA500 && lastClose < lastSMA50)
          trend = `Downtrend üìâ (${lastClose.toFixed(2)})`;
        else
          trend = `Sideways ‚û°Ô∏è (${lastClose.toFixed(2)})`;
      } else {
        trend = `Insufficient data (${lastClose ? lastClose.toFixed(2) : "-"})`;
      }

      return { symbol, trend, SMA50: lastSMA50, SMA100: lastSMA100, SMA200: lastSMA200, SMA500: lastSMA500 };
    } catch (err) {
      console.error("Twelve Data error", symbol, err);
      return { symbol, trend: "Error fetching data" };
    }
  }

  async function fetchDataAndRender() {
    try {
      statusText.innerText = "Fetching...";
      loadingBlock.style.display = '';
      resultsTable.style.display = 'none';
      resultsBody.innerHTML = '';

      const yahooPromises = yahooSymbols.map(s => getYahooTrend(s));
      const twelvePromises = twelveSymbols.map(s => getTwelveTrend(s));

      const rows = await Promise.all([...yahooPromises, ...twelvePromises]);

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.symbol}</td>
          <td>${r.trend}</td>
          <td>${r.SMA50 ? r.SMA50.toFixed(2) : "-"}</td>
          <td>${r.SMA100 ? r.SMA100.toFixed(2) : "-"}</td>
          <td>${r.SMA200 ? r.SMA200.toFixed(2) : "-"}</td>
          <td>${r.SMA500 ? r.SMA500.toFixed(2) : "-"}</td>
        `;
        resultsBody.appendChild(tr);
      });

      resultsTable.style.display = '';
      statusText.innerText = "Updated: " + new Date().toLocaleString();
    } catch (err) {
      statusText.innerText = "Error";
      console.error(err);
      alert("Error fetching data. See console for details.");
    } finally {
      loadingBlock.style.display = 'none';
    }
  }

  unlockBtn.addEventListener('click', () => {
    try {
      const decrypted = CryptoJS.AES.decrypt(encryptedPassword, encryptionKey).toString(CryptoJS.enc.Utf8);
      if (passwordInput.value === decrypted) {
        authorized = true;
        loginView.style.display = 'none';
        mainView.style.display = '';
        fetchDataAndRender();
      } else alert("Wrong password!");
    } catch {
      alert("Decryption error");
    }
  });

  passwordInput.addEventListener('keydown', e => { if (e.key === 'Enter') unlockBtn.click(); });
  refreshBtn.addEventListener('click', () => { if (authorized) fetchDataAndRender(); });
  passwordInput.focus();
})();
</script>
</body>
</html>
